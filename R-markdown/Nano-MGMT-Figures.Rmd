---
title: "Targeted Nanopore sequencing for MGMT promoter methylation evaluation"
SUbtitle: "Figures and data transformation"
author: "Skarphedinn Halldorsson"
date: "Compiled on `r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    latex_engine: pdflatex
    extra_dependencies: subfig, float
    number_sections: yes
    toc: no
  word_document:
    toc: no
    toc_depth: '3'
  html_document:
    toc: yes
    toc_depth: '3'
    df_print: paged
editor_options:
  chunk_output_type: console
subtitle: Preliminary data analysis
header-includes:
- \usepackage{fancyhdr}
- \usepackage{mathtools}
- \usepackage{hyperref}
- \usepackage{subfig}
- \setlength{\headheight}{33pt}
- \setlength{\footskip}{25pt}
- \pagestyle{fancy}
- \renewcommand{\headrulewidth}{0.5pt}
- \renewcommand{\footrulewidth}{0.5pt}
- \cfoot{\scriptsize Vilhelm Magnus Laboratory | Institute for surgical research \\
  Oslo University Hospital}
- \rhead{\thepage}
- \hypersetup{colorlinks   = true, linkcolor=blue, urlcolor  = blue}
- \fancypagestyle{plain}{\pagestyle{fancy}}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(dpi = 100, 
                      echo=TRUE, 
                      warning=FALSE, message=FALSE, eval = TRUE,
                      fig.show=TRUE, fig.width= 5,fig.height= 5,fig.align='center',
                      out.width = '50%', fig.path= 'Figures/')
```

## Figures

### MGMT Promoter CpG island and methods of evaluation
```{r Promoter, echo=FALSE, out.width="100%", fig.cap="Organization of the MGMT promoter. MSP refers to the typical primer sites of methylation specific PCR to determine MGMT promoter methylation. Asterixes represent the 4 CpGs analysed by the Qiagen MGMT pyrosequencing kit."}

knitr::include_graphics("Figures/MGMT_promoter_region.png")
```


```{r MGMT_stats, echo=FALSE}
load("Data/DotplotData.RData")
library(ggplot2)
library(dplyr)
library(tidyr)
library(janitor)
library(kableExtra)
library(RColorBrewer)


Table <- MGMT_RunSum %>% 
  select(Sample_ID,Series,Diagnosis) %>% 
  distinct() %>% 
  group_by(Series,Diagnosis) %>% 
  tally() %>% 
  spread(Diagnosis,n) %>% 
  replace(is.na(.), 0) %>%
  adorn_totals("row") %>%
  mutate(Other = rowSums(select(.,c(ATRT_SHH, Ganglioglioma, HPC, Medulloblastoma, PCNSL, PXA, Unknown)))) %>%
  select(c(Series,Astrocytoma,`Astrocytoma HG`, Glioblastoma, LGG_PA,Meningioma, Metastasis, Oligodendroglioma,Other))


```

Table has been reformated for Latex
```{r Sample_overview, echo=FALSE}

#knitr::kable(Table,align = "lccccccc", format="pipe", booktabs=TRUE, caption = "Overview of samples included in this study") 

#knitr::kable(Table,align = "lccccccc", format="html", booktabs=TRUE, caption = "Overview of samples included in this study") 

knitr::kable(Table,align = "lccccccc", format="latex", caption = "Overview of samples included in this study") %>% kable_styling(latex_options="scale_down")

```

### Overview of samples included in study
```{r, Methylation_overview, echo=FALSE,  out.width="75%", fig.cap="Distribution of methylated versus unmethylated samples according to known status prior to nanopore sequencing"}
ggplot(MGMT_RunSum, aes(y=Diagnosis, fill=Pyro_Methylation_Status))+
  geom_bar(stat = "count")+
  scale_fill_brewer(name="Mehtylation Status", palette="Set1")+
  theme_bw()+
  theme(legend.position = "top")

```

Also simplified version

```{r Methylation_overview_simplified, echo=FALSE, out.width="100%", fig.cap="Distribution of methylated versus unmethylated samples according to known status prior to nanopore sequencing"}
barplot_data <- MGMT_RunSum %>% select(c(Sample_ID, Diagnosis, Pyro_Methylation_Status)) %>%
  distinct() %>% 
  group_by(Diagnosis, Pyro_Methylation_Status) %>% 
  tally() %>%
  spread(Diagnosis,n) %>%
  replace(is.na(.), 0) %>%
  mutate(Other = rowSums(select(.,c(LGG_PA,ATRT_SHH, Ganglioglioma, HPC, Medulloblastoma, PCNSL, PXA, Meningioma, Metastasis, Unknown)))) %>%
  mutate('IDH-glioma' = rowSums(select(.,c(Astrocytoma,`Astrocytoma HG`, Oligodendroglioma)))) %>%
  select(c(Pyro_Methylation_Status,'IDH-glioma', Glioblastoma, Other)) %>%
  gather(key=Diagnosis, value = Samples, -Pyro_Methylation_Status)


barplot_data$Diagnosis <- factor(barplot_data$Diagnosis, levels = c("Other",'IDH-glioma',"Glioblastoma" ))

ggplot(barplot_data, aes(y=Diagnosis, x= Samples, fill=Pyro_Methylation_Status, label = Samples))+
  geom_bar(stat = "identity")+
  scale_fill_brewer(name="Known Methylation Status", palette="Set1")+
  geom_text(size = 3, position = position_stack(vjust = 0.5))+
  theme_bw(base_size = 10)+
  theme(legend.position = "top", aspect.ratio = 0.3 )
```


## Data acquisition

```{r Coverage_Method, echo=FALSE, fig.cap="Sequencing depth of samples by method of acquisition, group median represented by red diamond. No bias in sequence depth observed between methylated and unmethylated samples."}
# Distribution of hits in RIO by Methylation status and sequencing method
ggplot(MGMT_RunSum, aes(x=Comment, y=On_target_seqs))+
  geom_point(size = 5, position = position_jitterdodge(0.2,0), alpha = 0.6, aes(color=Pyro_Methylation_Status))+
  scale_color_brewer(name="Methylation Status", palette = "Set1")+
  scale_fill_discrete(guide="none")+
   scale_x_discrete(labels = c("Adaptive", "Barcoded", "Single"))+
  stat_summary(fun=median, geom="point", shape= "-", size=18, color="black",alpha = 0.8,position = position_dodge(0.8), aes(fill=Pyro_Methylation_Status))+
  #ylim(0,125)+
  #scale_y_break(c(150, 250)) +
  scale_y_log10()+
  xlab ("")+
  ylab("Sequence depth") +
  theme_bw(base_size = 14) + theme(axis.text.x = element_text(angle = 45, hjust=1))
```

```{r Coverage_Dataset, echo=FALSE, fig.cap="Sequencing depth of methods, group median represented by red diamond. Single sample runs generally have higher sequence depth than barcoded samples or adaptive sampling."}
ggplot(MGMT_RunSum, aes(x=Series, y=On_target_seqs))+
  geom_point(size = 5, position = position_jitterdodge(0.2,0), alpha = 0.6, aes(color=Comment)) +
  stat_summary(fun=median, geom="point", shape="-", size=18, color="black",alpha = 0.8,position = position_dodge(0.8), aes(fill=Comment))+
  scale_color_viridis_d(name="Method")+
  scale_fill_discrete(guide="none")+
  labs(fill = "", color = "Method")+
  scale_color_viridis_d()+
  scale_y_log10()+
  xlab ("")+
  ylab("Sequence depth") +
  theme_bw(base_size = 14) + theme(axis.text.x = element_text(angle = 45, hjust=1))
```

## Direct comparison of Nanopore sequencing and Pyrosequencing

Group average as measured by nanopore and pyrosequencing
```{r Compare_Group, echo=FALSE, out.width="100%", fig.width=10, fig.height=5, fig.cap="Comparison of nanopore sequencing and Pyrosequencing results of 4 CpGs in exon 1 of the MGMT promoter. Plotted values are average methylation of 4 CpGs. Black horizontal and vertical lines mark the 9 percent cut-off value between methylated and unmethylated samples, as determined by pyrosequencing."}
library(ggpubr)
ggplot(Compare_CpGs_GROUP, aes(x=Pyro_4_CpG_average, y=Nano_4_CpG_average, color = DataSet)) +
  geom_smooth(method = "lm", color="black") +
  geom_point(aes(size=Coverage), alpha = 0.6)+
  stat_regline_equation(label.y = 2, label.x = 6,aes(label = ..rr.label..),color = "black", size=4)+
  scale_color_brewer(palette = "Set1", guide="none")+
  scale_size_continuous(name="Depth",breaks = c(5,10,50,100,850), range = c(1,16) )+
  xlab("Pyro sequencing")+
  ylab("Nanopore sequencing")+
  geom_hline(yintercept = 9)+
  geom_vline(xintercept = 9)+
  # scale_y_sqrt(breaks=c(10,25,50,75,100))+
  # scale_x_sqrt(breaks=c(10,25,50,75,100))+
  
  facet_wrap(.~DataSet)+
  theme_bw()
```

Comparison of individual CpGs as measured by nanopore and pyrosequencing

```{r Compare_Individual, echo=FALSE, out.width="100%", fig.cap="Comparison of individual CpGs within exon 1" }
ggplot(Compare_CpGs, aes(x=Pyro, y=Nano, color = Pos))+
  geom_smooth(method = lm, color="black")+
  stat_regline_equation(label.y = 2, label.x = 6,aes(label = ..rr.label..),color = "black")+
  geom_point(aes(size=On_target_seqs), alpha = 0.6)+
  scale_size_continuous(name="Depth",breaks = c(5,15,25,100,150), range = c(1,8))+
  # geom_hline(yintercept = 10)+
  # geom_vline(xintercept = 10)+
  xlab("Pyro sequencing")+
  ylab("Nanopore sequencing")+
  theme_bw()+
    scale_color_brewer(palette = "Set2", guide="none")+
  # scale_y_sqrt(breaks=c(10,25,50,75,100))+
  # scale_x_sqrt(breaks=c(10,25,50,75,100))+
  facet_wrap(.~Pos)

```

Use 4 CpG sites (methylation cutoff 9%) to classify all samples, compared to known status

```{r BeeSwarm, echo=FALSE, out.width="100%",fig.cap="Average nanopore sequencing percentage of CpGs 76-79 agains the Pyrosequencing classification"}

library(ggbeeswarm)


FOUR_CpGs <- read.csv("Data/FOUR_CpGs_MGMT_AllDataSets_04012023.csv")

Four_CpGs_group <- FOUR_CpGs %>% select(c(Sample_ID,Calls_num,Percent_Methylated)) %>%
  group_by(Sample_ID) %>% summarise(Average_Methylation = mean(Percent_Methylated))

Four_CpGs_group <- na.omit(Four_CpGs_group)

p <- left_join(MGMT_RunSum,Four_CpGs_group)

p <- p %>% select(Sample_ID,Series,On_target_seqs, Pyro_Methylation_Status,Average_Methylation)
p$Nano_Methylation_Status <- if_else(p$Average_Methylation > 9, "Methylated", "UnMethylated")
p$Nano_Pyro_Concordance <- if_else(p$Pyro_Methylation_Status == p$Nano_Methylation_Status, "Concordant", "Discordant")

p2 <- p %>% select(Sample_ID, Series, Nano_Pyro_Concordance) %>%distinct()  %>% group_by(Series, Nano_Pyro_Concordance) %>% tally()

#knitr::kable(p2)

ggplot(p, aes(x=Pyro_Methylation_Status, y=Average_Methylation, color = Series))+
  geom_hline(yintercept = 9)+
  geom_beeswarm(aes(size = On_target_seqs), alpha = 0.6, cex=3)+
  scale_size_continuous(name="Depth",breaks = c(5,10,50,100), range = c(1,10) )+
  scale_color_brewer(palette = "Set1", guide="none")+
  xlab("Classification by pyrosequencing")+
  ylab("Average methylation per nanopore")+
  facet_grid(.~Series)+
  theme_bw()
```
```{r Concordance, echo=FALSE}
knitr::kable(p2)
```


## Unsupervised clustering of nanopore results

```{r Corrolation_plot, echo=FALSE, eval=FALSE}
library(corrplot)
Metsum_ROI_long <- read.csv("Data/Metsum_ROI_long.csv", header = T, row.names = 1)
colnames(Metsum_ROI_long) <- c(-7:-1, 1:98,c("+1","+2", "+3","+4", "+5", "+6", "+7", "+8", "+9", "+10"))

# correlation of CpGs
corrplot(cor(Metsum_ROI_long), 
         method = "color",
         order = "original",
         #hclust.method = "ward.D",
         tl.cex = 0.4,
         tl.col = 'black')
```

```{r Heatmap, echo=FALSE,  out.width="100%", out.height="100%", fig.cap="Clustered heatmap of all samples based on nanopore sequencing of CpG island of the MGMT promoter"}

Metsum_ROI_long <- read.csv("Data/Metsum_ROI_long.csv", header = T, row.names = 1)
colnames(Metsum_ROI_long) <- c(-7:-1, 1:98,c("+1","+2", "+3","+4", "+5", "+6", "+7", "+8", "+9", "+10"))
load("Data/Annotations.Rdata")

library(pheatmap)
library(grid)
library(RColorBrewer)

Metsum_ROI_long_ISLAND <- Metsum_ROI_long[c(2:nrow(Metsum_ROI_long)),c(8:105)]

pheatmap(Metsum_ROI_long_ISLAND,
         cluster_rows = T, 
         cluster_cols = F,
         clustering_method = "ward.D",
         cutree_rows = 2,
         treeheight_row = 20,
         border_color = NA,
         scale = "none",
         drop_levels = T,
         color = rev(brewer.pal(n = 10, name = "Spectral")),
         fontsize_col = 4,
         fontsize_row = 4,
         fontsize = 6,
         legend = T,
         show_rownames = F,
         legend_breaks = seq(0,100,10),
          annotation_col = mat_col,
          annotation_row = row_anno,
         annotation_colors = ann_colors,
         main = "All samples,  (n=145)",
         legend_labels = c("0%","10%", "20%", "30%", "40%", "50%", "60%", "70%", "80%", "90%", "100%")
         )

```

Unsupervised clustering of all the samples included in the study shows very clear separation of methylated and unmethylated samples (Figure 7). The samples previously defined as unmethylated have very low methylation throughout the CpG island apart from the first 5 CpGs that are often methylated. Samples previously defined as methylated have a gradient of methylation which tends to show highest methylation values towards either end of the CpG island. Only six samples samples do not cluster according to their previously determined methylation status. Four of these samples belong to the DenStem cohort that is not directly comparable, as previously mentioned. A single sample from the Radium cohort was classified as methylated by pyrosequencing but clusters with the unmethylated samples. This sample is interesting as it has robust methylation in the fist exon but very low methylation elsewhere in the CpG island.

We can also look at methylation patterns specifically in the glioblastoma samples (Table 1).

```{r HeatmapGBM, echo=FALSE,  out.width="100%", out.height="100%", fig.cap="Heatmap showing unsupervised clustering of glioblastoma samples based on nanopore sequencing of the CpG island in the MGMT promoter"}

GBMs <- MGMT_RunSum %>% select(Sample_ID,Diagnosis) %>% filter(Diagnosis == "Glioblastoma") %>% distinct()

Metsum_ROI_long_GBM <- na.omit(Metsum_ROI_long_ISLAND[GBMs$Sample_ID,])

res <- pheatmap(Metsum_ROI_long_GBM,
         cluster_rows = T, 
         cluster_cols = F,
         clustering_method = "ward.D",
         cutree_rows = 2,
         scale = "none",
         border_color = NA,
         color = rev(brewer.pal(n = 10, name = "Spectral")),
         fontsize = 6,
         fontsize_col = 4,
         fontsize_row = 4,
        #  kmeans_k = 6,
         show_rownames = F,
         treeheight_row = 20,
         legend = T,
         legend_breaks = seq(0,100,10),
         annotation_col = mat_col,
        # angle_col = 45,
         annotation_row = row_anno,
         annotation_colors = ann_colors,
         main = "Glioblastoma samples ONLY (n=88)",
         legend_labels = c("0%","10%", "20%", "30%", "40%", "50%", "60%", "70%", "80%", "90%", "100%")
)

res

```

In Figure 8 we see that all of the Rapid-CNS GBM samples fall within their previously determined classes and only one of the Radium samples is "mis-classified". We also see there are clusters within both the methylated and unmethylated samples. These clusters can also be represented by mean methylation values within each cluster (Figure 9).

```{r Kmeans, echo=FALSE,  out.width="100%", out.height="100%", fig.cap="K-means clustering of glioblastoma samples"}
GBMs <- MGMT_RunSum %>% select(Sample_ID,Diagnosis) %>% filter(Diagnosis == "Glioblastoma") %>% distinct()

Metsum_ROI_long_GBM <- na.omit(Metsum_ROI_long_ISLAND[GBMs$Sample_ID,])

pheatmap(Metsum_ROI_long_GBM,
         cluster_rows = T, 
         cluster_cols = F,
         clustering_method = "ward.D",
         cutree_rows = 2,
         scale = "none",
         border_color = NA,
         color = rev(brewer.pal(n = 10, name = "Spectral")),
         fontsize = 6,
         fontsize_col = 4,
         fontsize_row = 4,
          kmeans_k = 4,
         show_rownames = F,
         treeheight_row = 10,
         legend = T,
         legend_breaks = seq(0,100,10),
         annotation_col = mat_col,
        # angle_col = 45,
        # annotation_row = row_anno,
         #annotation_colors = ann_colors,
        # main = "Glioblastoma samples ONLY (n=127)",
         legend_labels = c("0%","10%", "20%", "30%", "40%", "50%", "60%", "70%", "80%", "90%", "100%")
)
```
## Survival analysis

{NEEDS UPDATE}Patient survival data is currently only available for 43 patients, including 37 GBM patients. Of these, 26 are primary GBMs. Comparison of survival of these 26 patients can be seen in figure 10. There is little difference between the results if patients are classified by pyrosequencing or nanopore sequencing, only two patients switch groups. We are expecting more data to strengthen these results. But they are promising: classification by nanopore sequencing is as good or better than pyrosequencing.
```{r KaplanMeier, echo=FALSE,  out.width="100%", out.height="100%", fig.cap="Kaplan-Meier Overall Survival curves"}
Patient_meta <- read.csv("Data/Patient_Survival.csv")

MGMT_clusters <- data.frame(cluster=cutree(res$tree_row, k=2))

MGMT_clusters$Sample_ID <- rownames(MGMT_clusters)

cluster_surv <- inner_join(MGMT_clusters, Patient_meta, by="Sample_ID")

cluster_surv <- cluster_surv %>% filter(Diagnosis == "GBM")

cluster_surv$months_to_event <- as.numeric(cluster_surv$months_to_event)

cluster_surv_filt <- cluster_surv %>% filter(Reopr == 0)

####################### Survival
library(survival)
library(survminer)
library(lubridate)

# Unfiltered
fit1 <- survfit( Surv(cluster_surv$months_to_event, cluster_surv$censor) ~ cluster_surv$Pyro_state)
fit2 <- survfit( Surv(cluster_surv$months_to_event, cluster_surv$censor) ~ cluster_surv$cluster)


# Reopr filtered out
fit1_filt <- survfit( Surv(cluster_surv_filt$months_to_event, cluster_surv_filt$censor) ~ cluster_surv_filt$Pyro_state)
fit2_filt <- survfit( Surv(cluster_surv_filt$months_to_event, cluster_surv_filt$censor) ~ cluster_surv_filt$cluster)




# Kaplan-Meier plot
## Filtered
# By pyrosequencing results
ggsurvplot(
  fit = fit1_filt,
  data = cluster_surv_filt,
  palette = c("cornflowerblue","darkorange3"),
  xlab = "OS, Months", 
  ylab = "Overall survival probability",
  legend.title = "Classification by Pyrosequencing",
  legend.labs = c("Methylated", "Unmethylated"),
  pval = TRUE,
  pval.coord = c(0, 0.1),
  font.x = c(14, "bold", "black"),
  font.y = c(14, "bold", "black"),
  risk.table = TRUE)

# By nanopore clustering
ggsurvplot(
  fit = fit2_filt,
  data = cluster_surv_filt,
  
  palette = c("darkorange3","cornflowerblue"),
  xlab = "OS, Months", 
  ylab = "Overall survival probability",
  legend.title = "Classification by Nanopore cluster",
  #legend.labs = c("Cluster 1", "Cluster 2", "Cluster 3"),
  legend.labs = c("Cluster 1", "Cluster 2"),
  pval = TRUE,
  pval.coord = c(0, 0.1),
  font.x = c(14, "bold", "black"),
  font.y = c(14, "bold", "black"),
  risk.table = TRUE)

```


## Discussion

We have a fairly extensive dataset of 153 samples, including 91 GBMs. I've not seen data with this many samples that looks at methylation within the whole CpG island of MGMT. We have the option of looking for CpG methylation further upstream and downstream than the 98 CpG presented here, at least 10 CpGs in both directions without losing any samples due to lack of coverage. By focusing on high depth samples we can look much further. I have not included that here but will be looking into it and will report if I find anything interesting.

We can conclude that nanopore sequencing of the MGMT promoter region performs as well or better than standard methods such as pyrosequencing. This is true for both cas9 targetted sequencing of the MGMT promoter and inclusion of the MGMT promoter into an adaptive sequencing panel. Distinct subgroups within both methylated and unmethylated samples are captured via nanopore sequencing, it will be very interesting to see if there is a difference in patient outcome between these clusters.
